<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Accel Display</title>
  <style>
    body,html{margin:0;height:100vh;overflow:hidden;background:#000;font-family:system-ui,sans-serif;color:white}
    #bgVideo, #bgVimeo{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;object-fit:cover}
    #bgVimeo iframe{width:100%;height:100%;border:0}
    #tilesContainer{position:absolute;top:0;left:0;width:100%;height:100%;z-index:10}
    .tile{position:absolute;box-sizing:border-box;overflow:hidden;user-select:none;transition:all .6s}
    .tile img,.tile video,.tile iframe{width:100%;height:100%;object-fit:cover;display:block}
    .tile video{background:#000}
  </style>
</head>
<body>

  <!-- Persistent full-screen background (never destroyed) -->
  <video id="bgVideo" autoplay muted loop playsinline style="display:none"></video>
  <div id="bgVimeo" style="display:none"></div>

  <!-- All foreground tiles (refreshed every 8s) -->
  <div id="tilesContainer"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxPQCmFSUG_9W2N62hqo7tPI6M_T9GCFD2FveCnA8uOYZ0lHLmSNMQDIufXP03vmybZfg/exec";

    async function loadTiles() {
      try {
        const res = await fetch(API_URL + "?t=" + Date.now());
        if (!res.ok) throw new Error("HTTP " + res.status);
        const tiles = await res.json();

        // === 1. Handle persistent full-screen background (only once) ===
        let bgSet = false;
        tiles.forEach(t => {
          if (bgSet || !t.visible) return;
          if (t.type === "video" && t.width === "100%" && t.height === "100%" && parseInt(t.zindex || "0") <= 5) {
            if (t.content.match(/\.(mp4|webm|mov|ogg)$/i)) {
              document.getElementById("bgVideo").src = t.content;
              document.getElementById("bgVideo").style.display = "block";
              document.getElementById("bgVimeo").style.display = "none";
            } else if (t.content.includes("vimeo")) {
              const id = t.content.match(/vimeo.*\/(\d+)/)?.[1];
              if (id) {
                document.getElementById("bgVimeo").innerHTML = 
                  `<iframe src="https://player.vimeo.com/video/${id}?autoplay=1&loop=1&muted=1&background=1&title=0&byline=0&portrait=0" 
                           allow="autoplay; fullscreen" allowfullscreen></iframe>`;
                document.getElementById("bgVimeo").style.display = "block";
                document.getElementById("bgVideo").style.display = "none";
              }
            }
            bgSet = true;
          }
        });

        // === 2. Render all FOREGROUND tiles (refreshed every 8s) ===
        const container = document.getElementById("tilesContainer");
        container.innerHTML = "";

        tiles.forEach(t => {
          if (!t.visible || t.visible === "FALSE") return;
          // Skip the full-screen background tile
          if (t.type === "video" && t.width === "100%" && t.height === "100%" && parseInt(t.zindex || "0") <= 5) return;

          const tile = document.createElement("div");
          tile.className = "tile";

          tile.style.left   = t.x || "0%";
          tile.style.top    = t.y || "0%";
          tile.style.width  = t.width || "30%";
          tile.style.height = t.height || "20%";
          tile.style.background = t.bgcolor || "rgba(0,0,0,0.6)";
          tile.style.color = t.textcolor || "white";
          tile.style.fontSize = t.fontsize || "24px";
          tile.style.fontWeight = t.bold?.toLowerCase() === "yes" ? "bold" : "normal";
          tile.style.textAlign = t.align || "center";
          tile.style.padding = t.padding || "20px";
          tile.style.borderRadius = t.radius || "20px";
          tile.style.boxShadow = t.shadow || "0 8px 32px rgba(0,0,0,0.6)";
          tile.style.opacity = t.opacity ?? 1;
          tile.style.transform = t.rotate ? `rotate(${t.rotate}deg)` : "";
          tile.style.zIndex = t.zindex || "10";
          tile.style.display = "flex";
          tile.style.alignItems = "center";
          tile.style.justifyContent = "center";
          tile.style.textShadow = "0 2px 8px rgba(0,0,0,0.8)";

          if (t.type === "text" && t.content) {
            tile.innerHTML = t.content.replace(/\\n/g, "<br>");
          }
          else if (t.type === "image" && t.content) {
            tile.innerHTML = `<img src="${t.content}" alt="">`;
          }
          else if (t.type === "clock") {
            tile.innerHTML = `<div class="clock">88:88</div>`;
          }
          else if (t.type === "date") {
            tile.innerHTML = new Date().toLocaleDateString(undefined, {weekday:'long', month:'long', day:'numeric', year:'numeric'});
          }

          container.appendChild(tile);
        });

        // === 3. Live clock update (every second, no flicker) ===
        function updateClocks() {
          document.querySelectorAll(".clock").forEach(el => {
            el.textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
          });
        }
        updateClocks();
        setInterval(updateClocks, 1000);

      } catch (e) {
        console.error(e);
        document.getElementById("tilesContainer").innerHTML = 
          `<div style="color:red;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:32px">Error: ${e.message}</div>`;
      }
    }

    loadTiles();
    setInterval(loadTiles, 8000);   // only foreground refreshes
  </script>
</body>
</html>
