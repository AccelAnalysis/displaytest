<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Remote Display</title>
  <script src="https://www.youtube.com/iframe_api"></script>
  <style>
    body {
      margin: 0;
      height: 100vh;
      font-family: system-ui, sans-serif;
      color: white;
      background-image: url("./background.jpg"); 
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 0;
    }

    .content {
      position: relative;
      z-index: 1;
      padding: 6vh 6vw;
      text-shadow: 0 2px 8px rgba(0,0,0,0.8);
    }

    .content-panel {
      display: inline-block;
      padding: 4vh 4vw;
      background: rgba(0, 0, 0, 0.55);
      border-radius: 20px;
      max-width: 90vw;
    }
  </style>
</head>

<body id="pageBody">

<!-- Replace the old <video id="bgVideo"> with this -->
<div id="ytPlayerContainer" style="
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: -2;
  display: none;
  overflow: hidden;
"></div>

  <div class="overlay"></div>
  
  <div class="content">
    <div id="headline" style="font-size:48px;font-weight:700;"></div>
    <div id="subhead" style="font-size:28px;margin-top:10px;"></div>
    <div id="status" style="font-size:24px;margin-top:18px;color:crimson;"></div>
  </div> <!-- ✅ THIS WAS MISSING -->

  <script>
  const API_URL = "https://script.google.com/macros/s/AKfycbxPQCmFSUG_9W2N62hqo7tPI6M_T9GCFD2FveCnA8uOYZ0lHLmSNMQDIufXP03vmybZfg/exec";

  let ytPlayer = null;
  let currentVideoId = null;

  // Called automatically by YouTube when API is ready
  function onYouTubeIframeAPIReady() {
    // Player will be created later when needed
  }

  function createYouTubePlayer(videoId) {
    if (ytPlayer) {
      ytPlayer.loadVideoById(videoId);
      return;
    }

    ytPlayer = new YT.Player('ytPlayerContainer', {
      height: '100%',
      width: '100%',
      videoId: videoId,
      playerVars: {
        autoplay: 1,
        mute: 1,
        loop: 1,
        playlist: videoId,       // required for true looping
        controls: 0,
        showinfo: 0,
        modestbranding: 1,
        iv_load_policy: 3,
        fs: 0,
        rel: 0,
        disablekb: 1,
        playsinline: 1,
        start: 0,
        enablejsapi: 1,
        origin: location.origin
      },
      events: {
        'onReady': (e) => { e.target.playVideo(); e.target.mute(); },
        'onStateChange': (e) => {
          if (e.data === YT.PlayerState.ENDED) {
            e.target.playVideo(); // fallback loop
          }
        }
      }
    });
  }

  async function refreshDisplay() {
    try {
      const res = await fetch(API_URL, { cache: "no-store" });
      const data = await res.json();

      document.getElementById("headline").textContent = data.headline || "";
      document.getElementById("subhead").textContent  = data.subhead  || "";
      document.getElementById("status").textContent   = data.status   || "";

      const body = document.getElementById("pageBody");
      const ytContainer = document.getElementById("ytPlayerContainer");

      // === Extract YouTube ID from various formats ===
      let ytId = null;
      if (data.videoUrl && data.videoUrl.trim()) {
        const match = data.videoUrl.match(/(?:youtube\.com\/(?:.*v=|embed\/|watch\?v=)|youtu\.be\/)([^?&"'>]+)/i);
        ytId = match ? match[1] : null;
      }

      // === PRIORITY: YouTube video → iframe player ===
      if (ytId && ytId !== currentVideoId) {
        body.style.backgroundImage = "none";
        ytContainer.style.display = "block";
        createYouTubePlayer(ytId);
        currentVideoId = ytId;
      } 
      // === NO YouTube → fall back to static image (or your old direct video if you still want) ===
      else if (!ytId) {
        if (ytPlayer) {
          ytPlayer.destroy();
          ytPlayer = null;
          currentVideoId = null;
        }
        ytContainer.style.display = "none";

        if (data.bgUrl && data.bgUrl.trim()) {
          body.style.backgroundImage = `url('${data.bgUrl}')`;
          body.style.backgroundSize = "cover";
          body.style.backgroundPosition = "center";
          body.style.backgroundRepeat = "no-repeat";
        } else {
          body.style.backgroundImage = "url('./background.jpg')";
        }
      }

    } catch (err) {
      console.error("Display refresh failed", err);
    }
  }

  refreshDisplay();
  setInterval(refreshDisplay, 5000);
</script>

</body>
</html>
