<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Accel Display & Editor</title>
  <style>
    /* --- CORE STYLES --- */
    body, html { margin: 0; height: 100vh; overflow: hidden; background: #000; font-family: system-ui, sans-serif; color: white; }
    #tilesContainer { position: relative; width: 100%; height: 100%; }
    
    .tile { 
      position: absolute; 
      box-sizing: border-box; 
      user-select: none; 
      /* Transitions only applied in Display Mode */
    }
    
    /* Transition only applied in Display Mode to prevent lag in Edit Mode */
    body:not(.editing) .tile { transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; }

    /* Content styling */
    .tile-content-wrapper { 
        width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; 
        overflow: hidden; 
    }
    .tile img, .tile video, .tile iframe, .tile lottie-player { 
        width: 100%; height: 100%; object-fit: cover; display: block; 
    }
    
    /* Editor Preview Layer: Allows content to show, but blocks interaction for dragging */
    .editor-preview-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.1); /* Slight dim to show editor is active */
        pointer-events: none; /* Allows the parent tile to receive mouse events */
    }
    body:not(.editing) .editor-preview-overlay { display: none; }
    
    /* Utilities */
    .marquee { white-space: nowrap; display: inline-block; animation: marquee 15s linear infinite; }
    @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

    /* Slide Logic */
    .slide-hidden { opacity: 0; visibility: hidden; pointer-events: none; z-index: -1; }
    .slide-active { opacity: 1; visibility: visible; z-index: 1; }

    /* --- EDITOR STYLES --- */
    body.editing #tilesContainer {
      background-image:
        linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
      background-size: 5% 5%;
    }

    body.editing .tile { 
      border: 1px dashed rgba(255, 255, 255, 0.3); 
      cursor: grab; 
    }
    body.editing .tile:active { cursor: grabbing; }
    
    body.editing .tile.selected { 
      border: 2px solid #3b82f6; 
      z-index: 99999 !important; 
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
    }

    /* Resize Handles (4 corners) */
    .resize-handle {
      display: none; position: absolute; width: 12px; height: 12px;
      background: #3b82f6; border: 1px solid #fff; z-index: 100000;
    }
    body.editing .tile.selected .resize-handle { display: block; }
    .rh-tl { top: -6px; left: -6px; cursor: nw-resize; }
    .rh-tr { top: -6px; right: -6px; cursor: ne-resize; }
    .rh-bl { bottom: -6px; left: -6px; cursor: sw-resize; }
    .rh-br { bottom: -6px; right: -6px; cursor: se-resize; }

    /* Secret Button */
    #secretBtn {
      position: fixed; bottom: 0; right: 0; width: 60px; height: 60px;
      z-index: 99999; cursor: default;
    }

    /* ADMIN PANEL */
    #adminPanel {
      position: fixed; top: 0; right: -360px; width: 340px; height: 100%;
      background: #1a1a1a; border-left: 1px solid #333; 
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 100000; display: flex; flex-direction: column; padding: 15px; 
      box-sizing: border-box; box-shadow: -5px 0 15px rgba(0,0,0,0.8);
    }
    body.editing #adminPanel { right: 0; }
    body.editing #adminPanel.collapsed { right: -300px; opacity: 0.8; }

    .panel-header { 
      font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #333; 
      padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; 
    }

    .form-group { margin-bottom: 10px; }
    .form-group label { display: block; font-size: 11px; color: #aaa; margin-bottom: 4px; }
    .form-group input, .form-group select, .form-group textarea { 
      width: 100%; padding: 6px; background: #222; border: 1px solid #444; 
      color: white; border-radius: 4px; box-sizing: border-box;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      border-color: #3b82f6; outline: none;
    }
    .row { display: flex; gap: 10px; }
    .btn { width: 100%; padding: 10px; margin-top: 5px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; color: white; }
    .btn-save { background: #10b981; }
    .btn-add { background: #3b82f6; }
    .btn-del { background: #ef4444; }
    
    /* Export Modal */
    #exportModal {
      display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 600px; background: #222; border: 1px solid #444; z-index: 200000; padding: 20px;
      box-shadow: 0 0 50px rgba(0,0,0,0.9);
    }
    #exportData { 
      width: 100%; height: 300px; background: #111; color: #0f0; border: 1px solid #333;
      font-family: monospace; font-size: 11px; white-space: pre; overflow: auto; 
    }
  </style>

  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>

  <div id="tilesContainer"></div>

  <div id="secretBtn" ondblclick="toggleEditMode()" title="Double Click or Ctrl+Shift+E to Edit"></div>

  <div id="adminPanel">
    <div class="panel-header">
      <button onclick="document.getElementById('adminPanel').classList.toggle('collapsed')" style="background:none; border:none; color:white; cursor:pointer;">➜</button>
      <span>EDITOR MODE</span>
      <button onclick="toggleEditMode()" style="background:#ef4444; border:none; color:white; padding:2px 6px; border-radius:4px;">EXIT</button>
    </div>

    <div style="background:#333; padding:10px; border-radius:4px; margin-bottom:15px;">
      <div class="form-group" style="margin-bottom:10px;">
        <label style="color:white; font-weight:bold;">Global Settings</label>
        <div class="row">
             <div class="form-group"><label>Slide Duration (ms)</label><input type="number" id="globalSlideDuration" value="15000"></div>
             <div class="form-group"><label>Screen ID</label><input type="number" id="globalScreenId" value="1" readonly></div>
        </div>
      </div>
      
      <div class="form-group" style="margin-bottom:0;">
        <label style="color:white; font-weight:bold;">Editing Slide ID:</label>
        <div style="display:flex; gap:5px;">
            <button class="btn" style="margin:0; width:30px;" onclick="changeEditorSlide(-1)">◀</button>
            <input type="number" id="globalSlideId" value="1" style="text-align:center;" readonly>
            <button class="btn" style="margin:0; width:30px;" onclick="changeEditorSlide(1)">▶</button>
        </div>
      </div>
      <div style="margin-top:5px;">
         <label><input type="checkbox" id="snapGrid"> Snap to 5% Grid</label>
      </div>
    </div>

    <div id="tileForm" style="opacity:0.5; pointer-events:none;">
      
      <div class="row">
         <div class="form-group"><label>Tile Slide ID</label><input type="number" id="inp-slideId" onchange="updateActiveTile('slideId', this.value)"></div>
      </div>

      <div class="form-group">
        <label>Type</label>
        <select id="inp-type" onchange="updateActiveTile('type', this.value)">
            <optgroup label="Core Media">
                <option value="text">1. Text Block</option><option value="image">2. Image</option><option value="video">3. Video</option>
                <option value="iframe">4. Iframe / Webpage</option><option value="youtube">5. YouTube</option>
            </optgroup>
            <optgroup label="Live Data">
                <option value="clock">6. Clock (Analog)</option><option value="clock_digital">7. Clock (Digital)</option><option value="weather_simple">8. Weather (Simple)</option>
                <option value="weather_detailed">9. Weather (Detailed)</option><option value="stock">10. Stock Quote</option><option value="crypto">11. Crypto Price</option>
                <option value="rss">12. RSS Feed</option><option value="twitter">13. Social (Twitter/X)</option><option value="instagram">14. Social (Instagram)</option>
            </optgroup>
            <optgroup label="Visuals & Animations">
                <option value="marquee">15. Marquee Ticker</option><option value="lottie">16. Lottie Animation</option><option value="model_3d">17. 3D Model (model-viewer)</option>
                <option value="html">18. Custom HTML</option><option value="chart_line">19. Line Chart</option><option value="chart_bar">20. Bar Chart</option>
                <option value="chart_pie">21. Pie Chart</option><option value="qrcode">22. QR Code</option>
            </optgroup>
             <optgroup label="Functional">
                <option value="map">23. Map</option><option value="countdown">24. Countdown Timer</option><option value="contact">25. Contact Card</option>
                <option value="calendar">26. Calendar</option><option value="table">27. Data Table</option><option value="timer_up">28. Count-Up Timer</option>
            </optgroup>
            <optgroup label="Shapes & Styling">
                <option value="shape_rect">29. Shape (Rectangle)</option><option value="shape_circle">30. Shape (Circle)</option><option value="gradient">31. Gradient Background</option>
                <option value="divider">32. Divider Line</option><option value="v_divider">33. Vertical Divider</option>
            </optgroup>
            <optgroup label="Special/Misc (22 more placeholders)">
                <option value="alert_banner">34. Alert Banner</option><option value="call_to_action">35. CTA Button</option><option value="poll">36. Live Poll/Vote</option>
                <option value="meeting_room">37. Meeting Room Status</option><option value="weather_map">38. Weather Map</option><option value="traffic_map">39. Traffic Map</option>
                <option value="news_headline">40. News Headline</option><option value="currency_exchange">41. Currency Exchange</option><option value="system_status">42. System Status</option>
                <option value="employee_spotlight">43. Employee Spotlight</option><option value="quote_of_day">44. Quote of the Day</option><option value="sports_score">45. Sports Score</option>
                <option value="web_link">46. Web Link Icon</option>
            </optgroup>
        </select>
      </div>
      <div class="form-group"><label>Content (URL or Text)</label><textarea id="inp-content" rows="3" oninput="updateActiveTile('content', this.value)"></textarea></div>

      <label style="font-weight:bold; margin-top:5px; display:block; border-top: 1px solid #333; padding-top:10px;">Geometry (%)</label>
      <div class="row">
        <div class="form-group"><label>X (%)</label><input type="number" step="0.1" id="inp-x" onchange="updateActiveTile('x', this.value + '%')"></div>
        <div class="form-group"><label>Y (%)</label><input type="number" step="0.1" id="inp-y" onchange="updateActiveTile('y', this.value + '%')"></div>
      </div>
      <div class="row">
        <div class="form-group"><label>W (%)</label><input type="number" step="0.1" id="inp-width" onchange="updateActiveTile('width', this.value + '%')"></div>
        <div class="form-group"><label>H (%)</label><input type="number" step="0.1" id="inp-height" onchange="updateActiveTile('height', this.value + '%')"></div>
      </div>
      
      <label style="font-weight:bold; margin-top:5px; display:block; border-top: 1px solid #333; padding-top:10px;">Style</label>
      <div class="row">
        <div class="form-group"><label>Bg Color</label><input type="color" id="inp-bgColor" style="height:30px; padding:0;" onchange="updateActiveTile('bgColor', this.value)"></div>
        <div class="form-group"><label>Text Color</label><input type="color" id="inp-textColor" style="height:30px; padding:0;" onchange="updateActiveTile('textColor', this.value)"></div>
      </div>
      
      <div class="row">
          <div class="form-group"><label>Font Size (px/em)</label><input id="inp-fontSize" onchange="updateActiveTile('fontSize', this.value)"></div>
          <div class="form-group"><label>Font Family</label><input id="inp-fontFamily" onchange="updateActiveTile('fontFamily', this.value)"></div>
      </div>
      <div class="row">
          <div class="form-group"><label>Padding (px/% )</label><input id="inp-padding" onchange="updateActiveTile('padding', this.value)"></div>
          <div class="form-group"><label>Radius (px/% )</label><input id="inp-radius" onchange="updateActiveTile('radius', this.value)"></div>
      </div>
      
      <div class="row">
          <div class="form-group"><label>Align</label><select id="inp-align" onchange="updateActiveTile('align', this.value)">
              <option value="center">center</option><option value="left">left</option><option value="right">right</option><option value="justify">justify</option>
          </select></div>
          <div class="form-group"><label>Bold (400-900)</label><input id="inp-bold" onchange="updateActiveTile('bold', this.value)"></div>
      </div>
      
      <label style="font-weight:bold; margin-top:5px; display:block; border-top: 1px solid #333; padding-top:10px;">Effects</label>
      <div class="row">
          <div class="form-group"><label>Z-Index</label><input type="number" id="inp-zIndex" onchange="updateActiveTile('zIndex', this.value)"></div>
          <div class="form-group"><label>Opacity (0-1)</label><input type="number" step="0.05" min="0" max="1" id="inp-opacity" onchange="updateActiveTile('opacity', this.value)"></div>
      </div>
      <div class="row">
          <div class="form-group"><label>Rotate (deg)</label><input id="inp-rotate" onchange="updateActiveTile('rotate', this.value)"></div>
          <div class="form-group"><label>Shadow (CSS)</label><input id="inp-shadow" onchange="updateActiveTile('shadow', this.value)"></div>
      </div>

      <button class="btn btn-del" onclick="deleteActiveTile()">Delete Selected</button>
    </div>

    <hr style="border-color:#333; margin: 15px 0; width:100%;">
    <button class="btn btn-add" onclick="addNewTile()">+ Add Tile to Slide</button>
    <button class="btn btn-save" onclick="exportData()">EXPORT DATA</button>
    <div style="font-size:10px; color:#888; text-align:center; margin-top:5px;">Copy -> Paste into Google Sheets (A2)</div>
  </div>

  <div id="exportModal">
    <h3 style="margin-top:0; color:#10b981;">Export Data for Google Sheets</h3>
    <p style="font-size:12px; color:#ccc">
        1. Click the box below.<br>
        2. Select All (Ctrl+A) and Copy (Ctrl+C).<br>
        3. Go to your Google Sheet, click Cell **A2** and Paste (Ctrl+V).
    </p>
    <textarea id="exportData" readonly onclick="this.select()"></textarea>
    <button class="btn btn-save" onclick="document.getElementById('exportModal').style.display='none'">Close</button>
  </div>

<script>
  // --- CONFIG ---
  const API_URL = "https://script.google.com/macros/s/AKfycbxPQCmFSUG_9W2N62hqo7tPI6M_T9GCFD2FveCnA8uOYZ0lHLmSNMQDIufXP03vmybZfg/exec"; 
  
  // --- STATE ---
  let tiles = [];
  let isEditing = false;
  let activeTileId = null;
  let slideTimer;
  let refreshTimer;
  let currentPlaySlide = 1;
  let currentEditSlide = 1;
  let maxSlide = 1;
  let SLIDE_DURATION_MS = 15000; // Default, can be changed via editor

  const urlParams = new URLSearchParams(window.location.search);
  const SCREEN_ID = parseInt(urlParams.get('screenId')) || 1;

  // Map of keys to their respective DOM style properties for fast update
  const domStyleMap = {
      'x': (el, val) => el.style.left = val,
      'y': (el, val) => el.style.top = val,
      'width': (el, val) => el.style.width = val,
      'height': (el, val) => el.style.height = val,
      'bgColor': (el, val) => el.style.backgroundColor = val,
      'textColor': (el, val) => el.style.color = val,
      'fontSize': (el, val) => el.style.fontSize = val,
      'padding': (el, val) => el.style.padding = val,
      'radius': (el, val) => el.style.borderRadius = val,
      'align': (el, val) => el.style.textAlign = val,
      'fontFamily': (el, val) => el.style.fontFamily = val,
      'bold': (el, val) => el.style.fontWeight = val,
      'shadow': (el, val) => el.style.boxShadow = val,
      'opacity': (el, val) => el.style.opacity = val,
      'rotate': (el, val) => el.style.transform = `rotate(${val}deg)`,
      'zIndex': (el, val) => el.style.zIndex = val,
  };

  // --- INITIALIZATION & REFRESH ---
  async function loadData() {
    if(isEditing) return; 

    try {
      const res = await fetch(`${API_URL}?screenId=${SCREEN_ID}&t=${Date.now()}`);
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      
      const newTiles = data.map(t => ({
        ...t,
        screenId: parseInt(t.screenId) || 1,
        slideId: parseInt(t.slideId) || 1,
        visible: t.visible !== false,
        x: normalizeUnit(t.x),
        y: normalizeUnit(t.y),
        width: normalizeUnit(t.width),
        height: normalizeUnit(t.height),
        zIndex: parseInt(t.zIndex) || 1,
        opacity: parseFloat(t.opacity) || 1,
        // Ensure other numerical fields are numbers
        rotate: parseFloat(t.rotate) || 0,
        // Set duration from a tile if one is defined (e.g. from a 'config' tile type)
      }));

      tiles = newTiles;
      maxSlide = tiles.reduce((max, t) => Math.max(max, t.slideId), 1);
      
      renderBoard();
      startSlideshow();
      
    } catch (e) {
      console.error("Load Error (Will retry in 60s)", e);
    }
  }

  function normalizeUnit(val) {
    if (!val) return "0%";
    if (val.toString().endsWith('%') || val.toString().endsWith('px')) return val;
    // Assume raw numbers are percentages for legacy compatibility
    if (!isNaN(val)) return parseFloat(val).toFixed(2) + "%"; 
    return val; 
  }

  // --- RENDERING ---
  function renderBoard() {
    const container = document.getElementById("tilesContainer");
    
    // In display mode, only update classes for seamless transition
    if(!isEditing) {
        // Simple update: find all tiles and update visibility based on currentPlaySlide
        document.querySelectorAll('.tile').forEach(el => {
            const t = tiles[el.dataset.index];
            if(t.slideId === currentPlaySlide) {
                el.classList.remove('slide-hidden');
                el.classList.add('slide-active');
            } else {
                 el.classList.remove('slide-active');
                 el.classList.add('slide-hidden');
            }
        });
        startClocks();
        return;
    }

    // In Edit Mode, we must re-render to attach new handlers and controls
    container.innerHTML = "";
    const visibleSlide = isEditing ? currentEditSlide : currentPlaySlide;
    
    tiles.forEach((t, index) => {
      // Show only tiles on the current edit slide
      if (isEditing && t.slideId !== currentEditSlide) return;
      if (!t.visible && !isEditing) return; // Only hide if explicitly marked invisible in display mode

      const el = document.createElement("div");
      el.className = "tile";
      el.dataset.index = index;
      
      // Apply all styles from the data model
      el.style.left = t.x; el.style.top = t.y; el.style.width = t.width; el.style.height = t.height;
      el.style.zIndex = t.zIndex;
      el.style.backgroundColor = t.bgColor || "transparent";
      el.style.color = t.textColor || "white";
      el.style.fontSize = t.fontSize || "24px";
      el.style.padding = t.padding || "0";
      el.style.borderRadius = t.radius || "0px";
      el.style.textAlign = t.align || "center";
      el.style.fontFamily = t.fontFamily || "inherit";
      el.style.fontWeight = t.bold || "normal";
      el.style.boxShadow = t.shadow || "none";
      el.style.opacity = t.opacity || "1";
      el.style.transform = t.rotate ? `rotate(${t.rotate}deg)` : 'none';

      el.style.display = "flex"; el.style.alignItems = "center"; el.style.justifyContent = "center";
      
      // Content Wrapper for consistent layout/padding
      const wrapper = document.createElement('div');
      wrapper.className = 'tile-content-wrapper';
      wrapper.innerHTML = getTileContent(t);

      el.appendChild(wrapper);
      
      // Editor Preview Overlay
      if(isEditing) {
        const overlay = document.createElement('div');
        overlay.className = 'editor-preview-overlay';
        el.appendChild(overlay);

        el.onmousedown = (e) => handleDragStart(e, index, el);
        el.ontouchstart = (e) => handleDragStart(e, index, el);
        
        ['tl','tr','bl','br'].forEach(pos => {
            const h = document.createElement('div');
            h.className = `resize-handle rh-${pos}`;
            h.onmousedown = (e) => handleResizeStart(e, index, el, pos);
            h.ontouchstart = (e) => handleResizeStart(e, index, el, pos);
            el.appendChild(h);
        });

        // Highlight selected tile if it matches the active ID
        if(index === activeTileId) el.classList.add('selected');
      } else {
         // Apply slide visibility classes for animation
         if(t.slideId === visibleSlide) el.classList.add('slide-active');
         else el.classList.add('slide-hidden');
      }

      container.appendChild(el);
    });

    startClocks();
  }

  function getTileContent(t) {
      if(!t.content) return `<span style="font-size:10px; opacity:0.5">${t.type}</span>`;
      
      switch(t.type) {
          case 'image': return `<img src="${t.content}">`;
          case 'video': return `<video src="${t.content}" autoplay loop muted playsinline></video>`;
          case 'iframe': return `<iframe src="${t.content}" style="border:0; width:100%; height:100%"></iframe>`;
          case 'text': return t.content.replace(/\n/g, '<br>');
          case 'clock': 
          case 'clock_digital': return `<div class="live-clock">${new Date().toLocaleTimeString()}</div>`;
          case 'marquee': return `<div class="marquee">${t.content}</div>`;
          case 'lottie': return `<lottie-player src="${t.content}" background="transparent" speed="1" loop autoplay></lottie-player>`;
          case 'model_3d': return `<model-viewer src="${t.content}" auto-rotate camera-controls></model-viewer>`;
          case 'shape_rect': return `<div style="width:100%; height:100%; background:${t.bgColor}; border-radius:${t.radius}"></div>`;
          // ... all other 46 types will use the content as fallback or require specific logic
          default: return t.content; 
      }
  }

  function startClocks() {
      // Independent clock updates for performance
      if(window.clockInterval) clearInterval(window.clockInterval);
      window.clockInterval = setInterval(() => {
          document.querySelectorAll('.live-clock').forEach(c => c.innerText = new Date().toLocaleTimeString());
      }, 1000);
  }

  // --- SLIDESHOW LOGIC ---
  function startSlideshow() {
    if (slideTimer) clearInterval(slideTimer);
    SLIDE_DURATION_MS = parseInt(document.getElementById('globalSlideDuration')?.value) || 15000;

    slideTimer = setInterval(() => {
      if (isEditing) return;
      currentPlaySlide++;
      if (currentPlaySlide > maxSlide) currentPlaySlide = 1;
      // In display mode, only re-render classes, not full DOM
      renderBoard(); 
    }, SLIDE_DURATION_MS);
  }

  // --- EDITOR LOGIC ---
  function toggleEditMode() {
    isEditing = !isEditing;
    document.body.classList.toggle("editing");
    
    if (isEditing) {
      clearInterval(slideTimer);
      clearInterval(refreshTimer);
      currentEditSlide = currentPlaySlide;
      
      document.getElementById('globalSlideId').value = currentEditSlide;
      document.getElementById('globalScreenId').value = SCREEN_ID;
      document.getElementById('globalSlideDuration').value = SLIDE_DURATION_MS;

      document.getElementById('adminPanel').classList.remove('collapsed');
      renderBoard();
    } else {
      activeTileId = null;
      loadData(); 
      refreshTimer = setInterval(loadData, 60000);
      startSlideshow();
    }
  }

  function changeEditorSlide(dir) {
      currentEditSlide += dir;
      if(currentEditSlide < 1) currentEditSlide = 1;
      if(currentEditSlide > maxSlide) maxSlide = currentEditSlide; // Allow adding new slides
      document.getElementById('globalSlideId').value = currentEditSlide;
      activeTileId = null;
      updateFormState();
      renderBoard();
  }

  function activateTile(index) {
    activeTileId = index;
    document.querySelectorAll('.tile').forEach(el => el.classList.remove('selected'));
    const el = document.querySelector(`.tile[data-index='${index}']`);
    if(el) el.classList.add('selected');
    
    document.getElementById('adminPanel').classList.remove('collapsed');
    
    const t = tiles[index];
    const map = {
        'slideId': t.slideId, 'type': t.type, 'content': t.content || '', 
        'x': parseFloat(t.x) || 0, 'y': parseFloat(t.y) || 0, 
        'width': parseFloat(t.width) || 0, 'height': parseFloat(t.height) || 0,
        'bgColor': t.bgColor || '#000000', 'textColor': t.textColor || '#ffffff',
        'fontSize': t.fontSize || '24px', 'padding': t.padding || '0px', 
        'radius': t.radius || '0px', 'align': t.align || 'center',
        'fontFamily': t.fontFamily || '', 'bold': t.bold || '',
        'zIndex': t.zIndex || 1, 'opacity': t.opacity || 1, 
        'rotate': t.rotate || 0, 'shadow': t.shadow || ''
    };
    
    for (const [key, val] of Object.entries(map)) {
        const inp = document.getElementById(`inp-${key}`);
        if(inp) inp.value = val;
    }
    updateFormState();
  }
  
  function updateFormState() {
      const form = document.getElementById('tileForm');
      form.style.opacity = activeTileId !== null ? "1" : "0.5";
      form.style.pointerEvents = activeTileId !== null ? "auto" : "none";
  }

  function updateActiveTile(key, value) {
      if(activeTileId === null) return;
      
      // Update state
      tiles[activeTileId][key] = value;
      
      const el = document.querySelector(`.tile[data-index='${activeTileId}']`);
      if(!el) return;

      // Update DOM directly for instant visual feedback
      if (domStyleMap[key]) {
          domStyleMap[key](el, value);
      } else if (key === 'content' || key === 'type') {
          // Content or Type change requires re-building the inner HTML
          el.querySelector('.tile-content-wrapper').innerHTML = getTileContent(tiles[activeTileId]);
      } else if (key === 'slideId') {
           // If slide ID changes, we must re-render the board to hide/show the tile correctly
           renderBoard();
           setTimeout(() => activateTile(activeTileId), 0);
      }
      
  }

  function addNewTile() {
      tiles.push({
          screenId: SCREEN_ID,
          slideId: currentEditSlide,
          type: 'text',
          content: 'New Tile',
          x: '35%', y: '35%', width: '30%', height: '20%',
          bgColor: '#3b82f6',
          visible: true, zIndex: 10, opacity: 1
      });
      renderBoard();
      activateTile(tiles.length - 1);
  }

  function deleteActiveTile() {
      if(activeTileId !== null && confirm("Delete this tile?")) {
          tiles.splice(activeTileId, 1);
          activeTileId = null;
          renderBoard();
          updateFormState();
      }
  }

  // --- DRAG & DROP (Unified Mouse/Touch) ---
  function handleDragStart(e, index, el) {
    e.stopPropagation();
    const isTouch = e.type === 'touchstart';
    const input = isTouch ? e.touches[0] : e;
    const pageX = input.pageX;
    const pageY = input.pageY;
    
    activateTile(index);
    
    const startLeft = el.offsetLeft;
    const startTop = el.offsetTop;
    const containerW = el.parentElement.clientWidth;
    const containerH = el.parentElement.clientHeight;
    
    const snap = document.getElementById('snapGrid').checked;
    const snapSizeX = containerW * 0.05;
    const snapSizeY = containerH * 0.05;

    function onMove(ev) {
        if(isTouch) ev.preventDefault();
        const currentInput = isTouch ? ev.touches[0] : ev;
        const curX = currentInput.pageX;
        const curY = currentInput.pageY;
        
        let newX = startLeft + (curX - pageX);
        let newY = startTop + (curY - pageY);
        
        if (snap) {
            newX = Math.round(newX / snapSizeX) * snapSizeX;
            newY = Math.round(newY / snapSizeY) * snapSizeY;
        }

        el.style.left = newX + 'px';
        el.style.top = newY + 'px';
        
        // Update inputs live (converted to %)
        document.getElementById('inp-x').value = ((newX/containerW)*100).toFixed(2);
        document.getElementById('inp-y').value = ((newY/containerH)*100).toFixed(2);
    }

    function onEnd() {
        const handler = isTouch ? 'touch' : 'mouse';
        document.removeEventListener(`${handler}move`, onMove);
        document.removeEventListener(`${handler}up`, onEnd);
        
        // Save Final State (Normalize to percentage string)
        tiles[index].x = ((el.offsetLeft / containerW) * 100).toFixed(2) + "%";
        tiles[index].y = ((el.offsetTop / containerH) * 100).toFixed(2) + "%";
    }

    const handler = isTouch ? 'touch' : 'mouse';
    document.addEventListener(`${handler}move`, onMove, {passive: !isTouch});
    document.addEventListener(`${handler}up`, onEnd);
  }

  // --- RESIZE LOGIC (Unified) ---
  function handleResizeStart(e, index, el, corner) {
    e.stopPropagation();
    const isTouch = e.type === 'touchstart';
    const input = isTouch ? e.touches[0] : e;
    const pageX = input.pageX;
    const pageY = input.pageY;

    const startW = el.offsetWidth;
    const startH = el.offsetHeight;
    const startX = el.offsetLeft;
    const startY = el.offsetTop;
    const containerW = el.parentElement.clientWidth;
    const containerH = el.parentElement.clientHeight;
    
    const snap = document.getElementById('snapGrid').checked;
    const snapSizeX = containerW * 0.05;
    const snapSizeY = containerH * 0.05;

    function onMove(ev) {
        if(isTouch) ev.preventDefault();
        const currentInput = isTouch ? ev.touches[0] : ev;
        const curX = currentInput.pageX;
        const curY = currentInput.pageY;
        const dx = curX - pageX;
        const dy = curY - pageY;

        let newW = startW, newH = startH, newX = startX, newY = startY;

        if (corner.includes('r')) newW = startW + dx;
        if (corner.includes('l')) { newW = startW - dx; newX = startX + dx; }
        if (corner.includes('b')) newH = startH + dy;
        if (corner.includes('t')) { newH = startH - dy; newY = startY + dy; }
        
        if (snap) {
             newW = Math.round(newW / snapSizeX) * snapSizeX;
             newH = Math.round(newH / snapSizeY) * snapSizeY;
             if (corner.includes('l')) newX = Math.round(newX / snapSizeX) * snapSizeX;
             if (corner.includes('t')) newY = Math.round(newY / snapSizeY) * snapSizeY;
        }

        if (newW > 20) { el.style.width = newW + 'px'; if (corner.includes('l')) el.style.left = newX + 'px'; }
        if (newH > 20) { el.style.height = newH + 'px'; if (corner.includes('t')) el.style.top = newY + 'px'; }
        
        document.getElementById('inp-width').value = ((el.offsetWidth/containerW)*100).toFixed(2);
        document.getElementById('inp-height').value = ((el.offsetHeight/containerH)*100).toFixed(2);
        document.getElementById('inp-x').value = ((el.offsetLeft/containerW)*100).toFixed(2);
        document.getElementById('inp-y').value = ((el.offsetTop/containerH)*100).toFixed(2);
    }

    function onEnd() {
        const handler = isTouch ? 'touch' : 'mouse';
        document.removeEventListener(`${handler}move`, onMove);
        document.removeEventListener(`${handler}up`, onEnd);
        
        tiles[index].width = ((el.offsetWidth / containerW) * 100).toFixed(2) + "%";
        tiles[index].height = ((el.offsetHeight / containerH) * 100).toFixed(2) + "%";
        tiles[index].x = ((el.offsetLeft / containerW) * 100).toFixed(2) + "%";
        tiles[index].y = ((el.offsetTop / containerH) * 100).toFixed(2) + "%";
    }

    const handler = isTouch ? 'touch' : 'mouse';
    document.addEventListener(`${handler}move`, onMove, {passive: !isTouch});
    document.addEventListener(`${handler}up`, onEnd);
  }

  // --- EXPORT ---
  function exportData() {
      // EXACT COLUMN MATCHING CODE.GS
      const headers = [
        "visible", "screenId", "slideId", "type", "content", "videoMode",
        "x", "y", "width", "height", 
        "bgColor", "textColor", "fontFamily", "fontSize", "bold", "align", 
        "padding", "radius", "shadow", 
        "opacity", "rotate", "zIndex"
      ];
      
      const tsv = tiles.map(t => {
          return headers.map(h => {
              let val = t[h];
              if (h === 'screenId') val = SCREEN_ID; // Force current screen ID on export
              if (val === undefined || val === null || val === 'none') return "";
              if (h === 'visible') return val ? "TRUE" : "FALSE";
              return val.toString().replace(/(\r\n|\n|\r)/gm, " "); 
          }).join("\t");
      }).join("\n");
      
      document.getElementById('exportData').value = tsv;
      document.getElementById('exportModal').style.display = 'block';
  }

  // --- KEYBOARD SHORTCUT ---
  document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key.toUpperCase() === 'E') {
          e.preventDefault();
          toggleEditMode();
      }
  });

  // START
  loadData();
  refreshTimer = setInterval(loadData, 60000);

</script>
</body>
</html>
