<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Accel Display</title>
  <style>
    body,html{margin:0;height:100vh;overflow:hidden;background:#000;font-family:system-ui,sans-serif;color:white}
    #bgVideo, #bgVimeo{position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:0}
    #tilesContainer{position:absolute;top:0;left:0;width:100%;height:100%;z-index:1}
    .tile{position:absolute;box-sizing:border-box;overflow:hidden;user-select:none;transition:all .6s}
    .tile img,.tile video,.tile iframe{width:100%;height:100%;object-fit:cover;display:block}
  </style>
</head>
<body>

  <!-- Persistent background (never destroyed) -->
  <video id="bgVideo" autoplay muted loop playsinline style="display:none"></video>
  <div id="bgVimeo" style="display:none"><iframe allow="autoplay; fullscreen" allowfullscreen></iframe></div>

  <!-- All other tiles go here (refreshed normally) -->
  <div id="tilesContainer"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxPQCmFSUG_9W2N62hqo7tPI6M_T9GCFD2FveCnA8uOYZ0lHLmSNMQDIufXP03vmybZfg/exec";

    let bgVideoActive = false;
    let bgVimeoActive = false;

    async function loadTiles() {
      try {
        const res = await fetch(API_URL + "?t=" + Date.now());
        if (!res.ok) throw new Error("HTTP " + res.status);
        const tiles = await res.json();

        // First pass: look for a full-screen background video/vimeo
        tiles.forEach(t => {
          if (t.visible === false) return;
          if (t.type === "video" && t.width === "100%" && t.height === "100%" && t.zindex == "1") {
            if (t.content.match(/\.(mp4|webm|mov|ogg)/i)) {
              // Direct MP4 background
              document.getElementById("bgVideo").src = t.content;
              document.getElementById("bgVideo").style.display = "block";
              document.getElementById("bgVimeo").style.display = "none";
              bgVideoActive = true;
            } else if (t.content.includes("vimeo")) {
              const id = t.content.match(/vimeo.*\/(\d+)/)?.[1];
              if (id) {
                const iframe = document.querySelector("#bgVimeo iframe");
                iframe.src = `https://player.vimeo.com/video/${id}?autoplay=1&loop=1&muted=1&background=1&title=0&byline=0&portrait=0`;
                document.getElementById("bgVimeo").style.display = "block";
                document.getElementById("bgVideo").style.display = "none";
                bgVimeoActive = |true;
              }
            }
          }
        });

        // Second pass: render all NON-fullscreen tiles (zIndex > 1 or not 100%x100%)
        const container = document.getElementById("tilesContainer");
        container.innerHTML = "";  // only wipe foreground tiles

        tiles.forEach(t => {
          if (t.visible === false) return;
          // Skip the full-screen background tile
          if (t.type === "video" && t.width === "100%" && t.height === "100%" && t.zindex == "1") return;

          const tile = document.createElement("div");
          tile.className = "tile";
          tile.style.left   = t.x || "0%";
          tile.style.top    = t.y || "0%";
          tile.style.width  = t.width || "30%";
          tile.style.height = t.height || "20%";
          tile.style.background = t.bgcolor || "rgba(0,0,0,0.6)";
          tile.style.color = t.textcolor || "white";
          tile.style.fontSize = t.fontsize || "24px";
          tile.style.fontWeight = t.bold?.toLowerCase() === "yes" ? "bold" : "normal";
          tile.style.textAlign = t.align || "center";
          tile.style.padding = t.padding || "20px";
          tile.style.borderRadius = t.radius || "20px";
          tile.style.boxShadow = t.shadow || "0 8px 32px rgba(0,0,0,0.6)";
          tile.style.opacity = t.opacity ?? 1;
          tile.style.transform = t.rotate ? `rotate(${t.rotate}deg)` : "";
          tile.style.zIndex = t.zindex || "10";
          tile.style.display = "flex";
          tile.style.alignItems = "center";
          tile.style.justifyContent = "center";
          tile.style.textShadow = "0 2px 8px rgba(0,0,0,0.8)";

          if (t.type === "text" && t.content) tile.innerHTML = t.content.replace(/\\n/g, "<br>");
          else if (t.type === "image" && t.content) tile.innerHTML = `<img src="${t.content}" alt="">`;
          else if (t.type === "clock") tile.innerHTML = `<div class="liveClock" style="font-size:3em;font-weight:bold"></div>`;
          else if (t.type === "date") tile.innerHTML = new Date().toLocaleDateString(undefined, {weekday:'long', year:'numeric', month:'long', day:'numeric'});
          // ... add other types as before

          container.appendChild(tile);
        });

        // Update all live clocks
        document.querySelectorAll(".liveClock").forEach(el => {
          el.textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        });

      } catch (e) { console.error(e); }
    }

    loadTiles();
    setInterval(loadTiles, 8000);   // foreground tiles refresh
    setInterval(() => {            // live clock updates every second (no full reload)
      document.querySelectorAll(".liveClock").forEach(el => {
        el.textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      });
    }, 1000);
  </script>
</body>
</html>
